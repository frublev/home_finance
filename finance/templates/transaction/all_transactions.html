{% extends 'base.html' %}
{% load static %}

{% load custom_filters %}
{% block content %}

<h4 class="account-title {% if balance_period < 0 %}negative{% else %}positive{% endif %}">
    {% if account_name %}
        {{ account_name }}
    {% else %}
        {% if active_type == 'income' %}
            Income
        {% elif active_type == 'outcome' %}
            Outcome
        {% else %}
            Balance
        {% endif %}
    {% endif %}
    <span class="account-balance {% if balance_period < 0 %}text-danger{% else %}text-success{% endif %}">
        â‚¬{{ balance_period|intspace }}
        <a href="{% url 'account_balance_period' '1' %}{% if active_filter %}?filter={{ active_filter }}{% else %}?filter={% endif %}{% if from_date %}&from_date={{ from_date }}{% endif %}{% if to_date %}&to_date={{ to_date }}{% endif %}"
            class="ms-2 text-secondary text-decoration-none small"
            title="Daily balance">Dynamic
        </a>
    </span>
</h4>

<div class="filters-actions-wrapper mb-3 d-flex flex-wrap align-items-center justify-content-between" style="gap: 0.75rem;">
    <!-- ðŸ”¹ Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð¿Ð¾ Ñ‚Ð¸Ð¿Ñƒ -->
    <div class="d-flex flex-wrap" style="gap: 0.5rem;">
        <a href="?{% for key, value in request.GET.items %}{% if key != 'type' %}{{ key }}={{ value }}&{% endif %}{% endfor %}type=None"
           class="type-filter-link {% if active_type == 'None' %}active{% endif %}">All</a>
        <a href="?{% for key, value in request.GET.items %}{% if key != 'type' %}{{ key }}={{ value }}&{% endif %}{% endfor %}type=income"
           class="type-filter-link {% if active_type == 'income' %}active{% endif %}">Income</a>
        <a href="?{% for key, value in request.GET.items %}{% if key != 'type' %}{{ key }}={{ value }}&{% endif %}{% endfor %}type=outcome"
           class="type-filter-link {% if active_type == 'outcome' %}active{% endif %}">Outcome</a>
        <span class="text-muted">|</span>
        <!-- ðŸ”¹ Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ -->
        <a href="?filter=today" class="filter-link {% if active_filter == 'today' %}active{% endif %}">Today</a>
        <a href="?filter=week" class="filter-link {% if active_filter == 'week' %}active{% endif %}">Week</a>
        <a href="?filter=month" class="filter-link {% if active_filter == 'month' %}active{% endif %}">Month</a>
    </div>

    <!-- ðŸ”¹ Ð¤Ð¾Ñ€Ð¼Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð° -->
    <form method="get" action="" class="d-flex flex-wrap align-items-center" style="gap: 0.25rem;">
        <input type="hidden" name="filter" value="">
        <label for="from_date" class="form-label fw-semibold mb-0 small text-muted">From:</label>
        <input type="date" id="from_date" name="from_date" value="{{ from_date }}" class="form-control form-control-sm" style="width: auto;">
        <label for="to_date" class="form-label fw-semibold mb-0 small text-muted">To:</label>
        <input type="date" id="to_date" name="to_date" value="{{ to_date }}" class="form-control form-control-sm" style="width: auto;">
        <input type="hidden" name="type" value="{{ active_type }}">
        <input type="hidden" name="account" value="{{ account }}">
        <button type="submit" class="btn btn-sm btn-success">Apply</button>
    </form>
</div>

<!-- ðŸ”¹ Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¹ -->
<table class="table table-hover align-middle">
    <thead>
        <tr>
            <th>Date</th>
            <th>Account</th>
            <th>Category</th>
            <th class="text-end">Amount</th>
        </tr>
    </thead>
    <tbody>
    {% for tx in transactions %}
        <tr onclick="window.location='{% if tx.category.type in 'Income,Outcome' %}{% url 'edit_transaction' tx.id %}{% else %}{% url 'edit_transfer' tx.transfer_id %}{% endif %}'">
            <td style="white-space: nowrap;">
                {% if tx.transaction_time.date == today %}
                    {{ tx.transaction_time|date:"H:i" }}
                {% else %}
                    {{ tx.transaction_time|date:"d M" }}
                {% endif %}
            </td>
            <td>{{ tx.account.name }}</td>
            <td>{{ tx.category.name }}</td>
            <td class="text-end {% if tx.category.type == 'Income' or tx.category.type == 'Transfer_to' %}text-success{% else %}text-danger{% endif %}"
                style="white-space: nowrap;">
                {% if tx.category.type == 'Income' or tx.category.type == 'Transfer_to' %}+{% else %}-{% endif %}{{ tx.amount }}
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="4" class="text-center text-muted py-3">No transactions found</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- ðŸ”¹ ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°Ð¼ -->
<div class="pagination-wrapper">
  {% if transactions.has_previous %}
    <a class="btn btn-outline-success pagination-btn"
       href="?page={{ transactions.previous_page_number }}&from_date={{ from_date }}&to_date={{ to_date }}&filter={{ active_filter }}{% if active_type %}&type={{ active_type }}{% endif %}{% if account %}&account={{ account }}{% endif %}">
       Previous
    </a>
  {% endif %}

  {% if transactions.has_next %}
    <a class="btn btn-next-custom pagination-btn"
       href="?page={{ transactions.next_page_number }}&from_date={{ from_date }}&to_date={{ to_date }}&filter={{ active_filter }}{% if active_type %}&type={{ active_type }}{% endif %}{% if account %}&account={{ account }}{% endif %}">
       Next
    </a>
  {% endif %}
</div>

<script src="{% static 'js/transactions_filters.js' %}"></script>

{% endblock %}
