{% extends "base.html" %}
{% load static %}

{% load custom_filters %}
{% block content %}
<h4 class="account-title {% if active_type == 'Outcome' %}negative{% else %}positive{% endif %}">
    <form method="get" class="d-inline">
        {# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞ #}
        <input type="hidden" name="type" value="{{ active_type }}">

        {# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–∞—Ç #}
        {% if active_filter %}
            <input type="hidden" name="filter" value="{{ active_filter }}">
        {% endif %}
        <select name="category_id" class="form-select d-inline w-auto" onchange="this.form.submit()">
            {% for cat in categories_for_filter %}
                <option value="{{ cat.id }}"
                        {% if selected_category and cat.id == selected_category.id %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>
    </form>
    <span class="account-balance {% if active_type == 'Outcome' %}text-danger{% else %}text-success{% endif %}">
        ‚Ç¨ {{ amount_to_title|intspace }}
    </span>
    {% if selected_category %}
        <a href="{% url 'category_detail' selected_category.id %}"
           class="btn btn-sm btn-outline-secondary ms-2">
            Details
        </a>
    {% endif %}
</h4>

<div class="filters-actions-wrapper mb-3">

    <!-- üîπ ROW 1: TYPE + TIME FILTERS -->
    <div class="d-flex flex-wrap align-items-center" style="gap: 0.5rem;">

        <a href="?type=income&filter={{ active_filter }}{% if selected_month %}&month={{ selected_month }}{% endif %}{% if selected_quarter %}&quarter={{ selected_quarter }}{% endif %}{% if selected_half %}&half={{ selected_half }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}"
           class="type-filter-link {% if active_type == 'Income' %}active{% endif %}">
            Income
        </a>

        <a href="?type=outcome&filter={{ active_filter }}{% if selected_month %}&month={{ selected_month }}{% endif %}{% if selected_quarter %}&quarter={{ selected_quarter }}{% endif %}{% if selected_half %}&half={{ selected_half }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}"
           class="type-filter-link {% if active_type == 'Outcome' %}active{% endif %}">
            Outcome
        </a>

        <span class="text-muted">|</span>

        <!-- TIME FILTERS -->
        <a href="?filter=this_month&type={{ active_type }}&category_id={{ category_id }}"
           class="filter-link {% if active_filter == 'this_month' %}active{% endif %}">
            Month
        </a>

        <a href="?filter=quarter&type={{ active_type }}&category_id={{ category_id }}"
           class="filter-link {% if active_filter == 'quarter' %}active{% endif %}">
            Quarter
        </a>

        <a href="?filter=half&type={{ active_type }}&category_id={{ category_id }}"
           class="filter-link {% if active_filter == 'half' %}active{% endif %}">
            Half
        </a>

        <a href="?filter=year&type={{ active_type }}&category_id={{ category_id }}"
           class="filter-link {% if active_filter == 'year' %}active{% endif %}">
            Year
        </a>
    </div>


    <!-- üîπ ROW 2: PERIOD FORM -->
    <div class="mt-2">
        <form method="get" action="" class="d-flex flex-wrap align-items-center" style="gap: 0.35rem;">

            <input type="hidden" name="type" value="{{ active_type }}">
            <input type="hidden" name="filter" value="{{ active_filter }}">
            <input type="hidden" name="category_id" value="{{ category_id }}">

            {% if active_filter == "this_month" %}
                <label class="form-label fw-semibold mb-0 small text-muted">Month</label>
                <select name="this_month" class="form-select form-select-sm" style="width: auto;">
                    {% for m in months %}
                        <option value="{{ m.num }}" {% if m.num == selected_month %}selected{% endif %}>
                            {{ m.name }}
                        </option>
                    {% endfor %}
                </select>

                <label class="form-label fw-semibold mb-0 small text-muted">Year</label>
                <select name="year" class="form-select form-select-sm" style="width: auto;">
                    {% for y in years %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>

            {% elif active_filter == "quarter" %}
                <label class="form-label fw-semibold mb-0 small text-muted">Quarter</label>
                <select name="quarter" class="form-select form-select-sm" style="width: auto;">
                    {% for q in quarters %}
                        <option value="{{ q.num }}" {% if q.num == selected_quarter %}selected{% endif %}>
                            {{ q.name }}
                        </option>
                    {% endfor %}
                </select>

                <label class="form-label fw-semibold mb-0 small text-muted">Year</label>
                <select name="year" class="form-select form-select-sm" style="width: auto;">
                    {% for y in years %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>

            {% elif active_filter == "half" %}
                <label class="form-label fw-semibold mb-0 small text-muted">Half:</label>
                <select name="half" class="form-select form-select-sm" style="width: auto;">
                    {% for h in halves %}
                        <option value="{{ h.num }}" {% if h.num == selected_half %}selected{% endif %}>
                            {{ h.name }}
                        </option>
                    {% endfor %}
                </select>

                <label class="form-label fw-semibold mb-0 small text-muted">Year:</label>
                <select name="year" class="form-select form-select-sm" style="width: auto;">
                    {% for y in years %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>

            {% elif active_filter == "year" %}
                <label class="form-label fw-semibold mb-0 small text-muted">Year:</label>
                <select name="year" class="form-select form-select-sm" style="width: auto;">
                    {% for y in years %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>
            {% endif %}

            <button type="submit" class="btn btn-sm btn-success">
                Apply
            </button>
        </form>
    </div>
</div>
<!-- üîπ CATEGORY TABLE -->
{% if category_transactions %}
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>Date</th>
                <th>Account</th>
                <th class="text-end">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for tx in category_transactions %}
                <tr onclick="window.location='{% if active_type in 'Income,Outcome' %}{% url 'edit_transaction' tx.id %}{% endif %}'">
                    <td style="white-space: nowrap;">
                        {% if tx.transaction_time.date == today %}
                            {{ tx.transaction_time|date:"H:i" }}
                        {% else %}
                            {{ tx.transaction_time|date:"d M" }}
                        {% endif %}
                    </td>
                    <td>
                        {{ tx.account.name }}
                    </td>
                    <td class="text-end {% if active_type == 'Income' %}text-success{% elif active_type == 'Outcome' %}text-danger{% endif %}"
                        style="white-space: nowrap;">
                        {{ tx.amount }}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No transaction in this period.</p>
{% endif %}

<!-- üîπ –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º -->
<div class="pagination-wrapper">
  {% if category_transactions.has_previous %}
    <a class="btn btn-outline-success pagination-btn"
       href="?page={{ category_transactions.previous_page_number }}&filter={{ active_filter }}&type={{ active_type }}&category_id={{ category_id }}&start_date={{ start_date }}&end_date={{ end_date }}">
       Previous
    </a>
  {% endif %}

  {% if category_transactions.has_next %}
    <a class="btn btn-next-custom pagination-btn"
       href="?page={{ category_transactions.next_page_number }}&filter={{ active_filter }}&type={{ active_type }}&category_id={{ category_id }}&start_date={{ start_date }}&end_date={{ end_date }}">
       Next
    </a>
  {% endif %}
</div>

<script src="{% static 'js/filter_cutting.js' %}"></script>

{% endblock %}